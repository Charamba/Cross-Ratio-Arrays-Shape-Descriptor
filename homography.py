import numpy as np
from numpy import linalg
import math

#matchedVerticesPairs = [((-335.000000, -468.000000), (-292.000000, -214.000000)), ((120.000000, -538.000000), (69.000000, -490.000000)), ((124.000000, -538.000000), (72.000000, -491.000000)), ((254.000000, -189.000000), (180.000000, -116.000000)), ((258.000000, -174.000000), (182.000000, -105.000000)), ((330.000000, 166.000000), (221.000000, 214.000000)), ((332.000000, 176.000000), (222.000000, 223.000000)), ((334.000000, 216.000000), (221.000000, 253.000000)), ((333.000000, 230.000000), (219.000000, 266.000000)), ((332.000000, 237.000000), (217.000000, 274.000000)), ((312.000000, 314.000000), (196.000000, 334.000000)), ((306.000000, 328.000000), (188.000000, 350.000000)), ((293.000000, 354.000000), (178.000000, 367.000000)), ((289.000000, 361.000000), (173.000000, 375.000000)), ((282.000000, 371.000000), (166.000000, 384.000000)), ((273.000000, 382.000000), (159.000000, 392.000000)), ((257.000000, 399.000000), (144.000000, 407.000000)), ((246.000000, 409.000000), (136.000000, 414.000000)), ((241.000000, 413.000000), (131.000000, 418.000000)), ((233.000000, 419.000000), (127.000000, 421.000000)), ((230.000000, 421.000000), (124.000000, 423.000000)), ((7.000000, 527.000000), (-27.000000, 500.000000)), ((-32.000000, 537.000000), (-51.000000, 507.000000)), ((-67.000000, 535.000000), (-74.000000, 507.000000)), ((-86.000000, 525.000000), (-90.000000, 499.000000)), ((-207.000000, 454.000000), (-156.000000, 464.000000)), ((-215.000000, 448.000000), (-159.000000, 462.000000)), ((-223.000000, 441.000000), (-165.000000, 457.000000)), ((-236.000000, 427.000000), (-172.000000, 450.000000)), ((-246.000000, 414.000000), (-177.000000, 444.000000)), ((-258.000000, 395.000000), (-184.000000, 434.000000)), ((-263.000000, 386.000000), (-191.000000, 422.000000)), ((-285.000000, 336.000000), (-201.000000, 402.000000)), ((-288.000000, 328.000000), (-204.000000, 395.000000)), ((-291.000000, 319.000000), (-206.000000, 390.000000)), ((-318.000000, 16.000000), (-240.000000, 191.000000)), ((-335.000000, -467.000000), (-292.000000, -213.000000))]

#matchedVerticesPairs = [((121.000000, -109.000000), (111.000000, -74.000000)), ((202.000000, -34.000000), (177.000000, -31.000000)), ((190.000000, -27.000000), (168.000000, -26.000000)), ((-137.000000, 114.000000), (-103.000000, 88.000000)), ((-192.000000, 118.000000), (-146.000000, 89.000000)), ((199.000000, -31.000000), (177.000000, -30.000000)), ((102.000000, 11.000000), (124.000000, -7.000000)), ((-156.000000, 119.000000), (-86.000000, 83.000000)), ((-195.000000, 117.000000), (-139.000000, 90.000000)), ((-205.000000, 112.000000), (-154.000000, 86.000000)), ((-221.000000, 97.000000), (-169.000000, 75.000000)), ((-225.000000, 87.000000), (-174.000000, 66.000000)), ((-225.000000, 66.000000), (-167.000000, 28.000000)), ((-224.000000, 61.000000), (-176.000000, 56.000000)), ((-223.000000, 57.000000), (-175.000000, 48.000000)), ((-219.000000, 45.000000), (-153.000000, 9.000000)), ((-213.000000, 32.000000), (-144.000000, -1.000000)), ((-208.000000, 23.000000), (-130.000000, -14.000000)), ((-202.000000, 13.000000), (-123.000000, -20.000000)), ((-120.000000, -109.000000), (-42.000000, -87.000000))]

#matchedVerticesPairs = [((198.000000, 131.000000), (98.000000, 39.000000)), ((201.000000, 138.000000), (98.000000, 49.000000)), ((210.000000, 164.000000), (97.000000, 52.000000)), ((-37.000000, 250.000000), (-102.000000, 16.000000)), ((-174.000000, 198.000000), (-81.000000, -21.000000)), ((210.000000, 161.000000), (95.000000, 52.000000)), ((-121.000000, 237.000000), (-103.000000, 3.000000)), ((-207.000000, 32.000000), (-67.000000, -28.000000)), ((-85.000000, -248.000000), (56.000000, -65.000000))]

#matchedVerticesPairs =  [((229.000000, -194.000000), (216.000000, -148.000000)), ((241.000000, 176.000000), (224.000000, 60.000000)), ((241.000000, 187.000000), (224.000000, 67.000000)), ((-84.000000, 189.000000), (-35.000000, 114.000000)), ((-240.000000, 187.000000), (-230.000000, 145.000000)), ((-241.000000, 15.000000), (-220.000000, -16.000000)), ((-240.000000, 12.000000), (-217.000000, -22.000000)), ((-237.000000, 6.000000), (-213.000000, -27.000000)), ((-235.000000, 3.000000), (-207.000000, -32.000000)), ((-226.000000, -6.000000), (-201.000000, -36.000000)), ((-222.000000, -9.000000), (-193.000000, -40.000000)), ((-211.000000, -15.000000), (-177.000000, -46.000000)), ((-189.000000, -24.000000), (-143.000000, -55.000000)), ((215.000000, -189.000000), (205.000000, -146.000000)), ((225.000000, -193.000000), (213.000000, -148.000000))]

# nike x nike3
#matchedVerticesPairs =  [((121.000000, -109.000000), (120.000000, -85.000000)), ((202.000000, -34.000000), (182.000000, -33.000000)), ((190.000000, -27.000000), (172.000000, -27.000000)), ((102.000000, 11.000000), (104.000000, 4.000000)), ((-225.000000, 87.000000), (-204.000000, 103.000000)), ((201.000000, -32.000000), (182.000000, -32.000000)), ((-58.000000, 80.000000), (-47.000000, 72.000000)), ((-195.000000, 117.000000), (-205.000000, 100.000000)), ((-223.000000, 93.000000), (-206.000000, 96.000000)), ((-223.000000, 57.000000), (-189.000000, 52.000000)), ((-219.000000, 45.000000), (-179.000000, 39.000000)), ((-215.000000, 36.000000), (-169.000000, 28.000000)), ((-208.000000, 23.000000), (-149.000000, 8.000000)), ((-194.000000, 1.000000), (-138.000000, -2.000000)), ((-120.000000, -109.000000), (-47.000000, -83.000000))]

#matchedVerticesPairs =  [((121.000000, -109.000000), (120.000000, -85.000000)), ((202.000000, -34.000000), (182.000000, -33.000000)), ((201.000000, -32.000000), (182.000000, -32.000000)), ((-225.000000, 66.000000), (-205.000000, 82.000000)), ((-219.000000, 45.000000), (-179.000000, 39.000000)), ((190.000000, -27.000000), (172.000000, -27.000000))]

#matchedVerticesPairs =  [((121.000000, -109.000000), (120.000000, -85.000000)), ((202.000000, -34.000000), (182.000000, -33.000000)), ((201.000000, -32.000000), (182.000000, -32.000000)), ((-225.000000, 66.000000), (-205.000000, 82.000000)), ((-219.000000, 45.000000), (-179.000000, 39.000000)), ((190.000000, -27.000000), (172.000000, -27.000000)), ((102.000000, 11.000000), (104.000000, 4.000000)), ((-58.000000, 80.000000), (-47.000000, 72.000000)), ((-192.000000, 118.000000), (-191.000000, 117.000000)), ((-195.000000, 117.000000), (-194.000000, 115.000000)), ((-205.000000, 112.000000), (-200.000000, 109.000000)), ((-221.000000, 97.000000), (-204.000000, 103.000000)), ((-223.000000, 93.000000), (-205.000000, 100.000000)), ((-225.000000, 87.000000), (-206.000000, 96.000000)), ((-223.000000, 57.000000), (-186.000000, 48.000000)), ((-215.000000, 36.000000), (-169.000000, 28.000000)), ((-202.000000, 13.000000), (-149.000000, 8.000000)), ((-194.000000, 1.000000), (-138.000000, -2.000000)), ((-120.000000, -109.000000), (-47.000000, -83.000000))]

# peugeot - peugeot 2
#matchedVerticesPairs =  [((401.000000, 244.000000), (373.000000, 233.000000)), ((401.000000, 263.000000), (375.000000, 250.000000)), ((-140.000000, 360.000000), (-101.000000, 165.000000)), ((-399.000000, 357.000000), (-361.000000, 60.000000)), ((-399.000000, 244.000000), (-296.000000, -38.000000)), ((-273.000000, -371.000000), (-36.000000, -295.000000)), ((277.000000, -371.000000), (248.000000, -169.000000))]

# Honda - Honda 2
#matchedVerticesPairs =  [((241.000000, 176.000000), (224.000000, 60.000000)), ((241.000000, 187.000000), (224.000000, 67.000000)), ((-84.000000, 189.000000), (-35.000000, 114.000000)), ((-241.000000, 15.000000), (-220.000000, -16.000000)), ((-226.000000, -6.000000), (-201.000000, -36.000000)), ((-222.000000, -9.000000), (-193.000000, -40.000000)), ((-211.000000, -15.000000), (-183.000000, -44.000000)), ((-189.000000, -24.000000), (-143.000000, -55.000000)), ((215.000000, -189.000000), (205.000000, -146.000000)), ((225.000000, -193.000000), (213.000000, -148.000000)), ((229.000000, -194.000000), (216.000000, -148.000000))]

#matchedVerticesPairs =  [((241.000000, 187.000000), (172.000000, 93.000000)), ((-240.000000, 187.000000), (177.000000, 63.000000)), ((-237.000000, 6.000000), (-182.000000, 86.000000)), ((-235.000000, 3.000000), (181.000000, 89.000000)), ((-219.000000, -11.000000), (133.000000, 10.000000)), ((-189.000000, -24.000000), (183.000000, 77.000000)), ((225.000000, -193.000000), (163.000000, 93.000000))]

#deficientes
#matchedVerticesPairs =  [((-43.000000, -232.000000), (72.000000, -59.000000)), ((-40.000000, -228.000000), (39.000000, 49.000000)), ((210.000000, 161.000000), (95.000000, 52.000000)), ((210.000000, 164.000000), (98.000000, 49.000000)), ((-37.000000, 250.000000), (-56.000000, 41.000000)), ((-66.000000, 251.000000), (-49.000000, 42.000000)), ((-83.000000, 249.000000), (-103.000000, 3.000000)), ((-109.000000, 242.000000), (-66.000000, 39.000000)), ((-186.000000, 183.000000), (-90.000000, -15.000000)), ((-210.000000, 133.000000), (-98.000000, -7.000000)), ((-207.000000, 32.000000), (-67.000000, -28.000000)), ((-118.000000, -220.000000), (-76.000000, -24.000000))]

#matchedVerticesPairs =  [((-292.000000, 4.000000), (-230.000000, -45.000000)), ((22.000000, -145.000000), (-9.000000, -126.000000)), ((288.000000, -146.000000), (141.000000, -113.000000)), ((291.000000, -143.000000), (143.000000, -112.000000)), ((199.000000, 146.000000), (246.000000, 107.000000)), ((194.000000, 148.000000), (243.000000, 110.000000)), ((189.000000, 148.000000), (246.000000, 100.000000)), ((-292.000000, 144.000000), (-247.000000, 117.000000))]

#matchedVerticesPairs =  [((-43.000000, -232.000000), (72.000000, -59.000000)), ((-40.000000, -228.000000), (39.000000, 49.000000)), ((210.000000, 161.000000), (95.000000, 52.000000)), ((210.000000, 164.000000), (98.000000, 49.000000)), ((-37.000000, 250.000000), (-56.000000, 41.000000)), ((-66.000000, 251.000000), (-49.000000, 42.000000)), ((-83.000000, 249.000000), (-103.000000, 3.000000)), ((-109.000000, 242.000000), (-66.000000, 39.000000)), ((-186.000000, 183.000000), (-90.000000, -15.000000)), ((-210.000000, 133.000000), (-98.000000, -7.000000)), ((-207.000000, 32.000000), (-67.000000, -28.000000)), ((-118.000000, -220.000000), (-76.000000, -24.000000))]

# del matchedVerticesPairs[5]
# del matchedVerticesPairs[-1]
# del matchedVerticesPairs[4]

#matchedVerticesPairs =  [((398.000000, -126.000000), (382.000000, -73.000000)), ((346.000000, 60.000000), (352.000000, 16.000000)), ((336.000000, 76.000000), (348.000000, 22.000000)), ((305.000000, 112.000000), (332.000000, 41.000000)), ((297.000000, 118.000000), (327.000000, 45.000000)), ((327.000000, 88.000000), (342.000000, 30.000000)), ((290.000000, 122.000000), (324.000000, 47.000000)), ((282.000000, 125.000000), (320.000000, 49.000000)), ((-55.000000, 129.000000), (90.000000, 80.000000)), ((-148.000000, 129.000000), (-1.000000, 92.000000)), ((-360.000000, 122.000000), (-300.000000, 124.000000)), ((-375.000000, 115.000000), (-323.000000, 122.000000)), ((-379.000000, 112.000000), (-338.000000, 119.000000)), ((-388.000000, 103.000000), (-345.000000, 117.000000)), ((-392.000000, 97.000000), (-371.000000, 104.000000)), ((-394.000000, 93.000000), (-387.000000, 83.000000)), ((-397.000000, 85.000000), (-385.000000, 87.000000)), ((-400.000000, 71.000000), (-388.000000, 80.000000)), ((-400.000000, 47.000000), (-390.000000, 59.000000)), ((-398.000000, 35.000000), (-388.000000, 48.000000)), ((-394.000000, 19.000000), (-383.000000, 33.000000)), ((-391.000000, 10.000000), (-378.000000, 23.000000)), ((-387.000000, 0.000000), (-371.000000, 12.000000)), ((-384.000000, -7.000000), (-366.000000, 5.000000)), ((-379.000000, -17.000000), (-356.000000, -7.000000)), ((-371.000000, -31.000000), (-343.000000, -20.000000)), ((-361.000000, -46.000000), (-319.000000, -40.000000)), ((-355.000000, -54.000000), (-315.000000, -43.000000)), ((-351.000000, -59.000000), (-305.000000, -50.000000)), ((-313.000000, -97.000000), (-245.000000, -83.000000)), ((-303.000000, -105.000000), (-223.000000, -92.000000)), ((-293.000000, -112.000000), (-215.000000, -95.000000)), ((-286.000000, -116.000000), (-199.000000, -100.000000)), ((-270.000000, -124.000000), (-174.000000, -106.000000)), ((-265.000000, -126.000000), (-162.000000, -108.000000)), ((-252.000000, -130.000000), (-153.000000, -109.000000)), ((-247.000000, -131.000000), (-142.000000, -110.000000))]

#matchedVerticesPairs =  [((-84.000000, 189.000000), (-575.000000, 276.000000)), ((-242.000000, 24.000000), (-541.000000, -48.000000)), ((-242.000000, 20.000000), (-551.000000, 276.000000)), ((-241.000000, 15.000000), (-97.000000, -211.000000)), ((-240.000000, 12.000000), (-575.000000, 267.000000)), ((-189.000000, -24.000000), (-571.000000, 229.000000)), ((215.000000, -189.000000), (-543.000000, -33.000000)), ((228.000000, -194.000000), (214.000000, -173.000000))]

#matchedVerticesPairs =  [((-43.000000, -232.000000), (72.000000, -59.000000)), ((-40.000000, -228.000000), (39.000000, 49.000000)), ((210.000000, 161.000000), (95.000000, 52.000000)), ((210.000000, 164.000000), (98.000000, 49.000000)), ((-37.000000, 250.000000), (-56.000000, 41.000000)), ((-66.000000, 251.000000), (-49.000000, 42.000000)), ((-83.000000, 249.000000), (-103.000000, 3.000000)), ((-109.000000, 242.000000), (-66.000000, 39.000000)), ((-186.000000, 183.000000), (-90.000000, -15.000000)), ((-210.000000, 133.000000), (-98.000000, -7.000000)), ((-207.000000, 32.000000), (-67.000000, -28.000000)), ((-118.000000, -220.000000), (-76.000000, -24.000000))]

P1 = []
P2 = []

for p1, p2 in matchedVerticesPairs:
    P1.append(p1)
    P2.append(p2)

def estimatePerspectiveTransformMatrix(P1, P2):
    A = []
    for i in range(0, len(P1)):
        x, y   = P1[i][0], P1[i][1]
        x_, y_ = P2[i][0], P2[i][1]
        A.append([x, y, 1, 0, 0, 0, -x_*x, -x_*y, -x_])
        A.append([0, 0, 0, x, y, 1, -y_*x, -y_*y, -y_])
    A = np.asarray(A)
    U, S, Vh = np.linalg.svd(A)
    L = Vh[-1,:] / Vh[-1,-1]
    H = L.reshape(3, 3)

    return H

def calcGeometricError(P1, P2, H):
    error = 0
    for (p1, p2) in list(zip(P1, P2)):
        p1 = [p1[0], p1[1], 1]
        q2 = np.dot(H, p1)

        (xp2, yp2) = p2

        q2 = (q2[0]/q2[2], q2[1]/q2[2]) # normalize
        (xq2, yq2) = q2

        print("e = ", math.sqrt((xp2-xq2)*(xp2-xq2) + (yp2-yq2)*(yp2-yq2)))
        error += math.sqrt((xp2-xq2)*(xp2-xq2) + (yp2-yq2)*(yp2-yq2))
    return error


H = estimatePerspectiveTransformMatrix(P1, P2)

print("H = ", H)

#p = [-335.000000, -468.000000, 1.0]
p = [120.000000, -538.000000, 1.0]

q = np.dot(H, p)
print("q norm. = ", q)
q = (q[0]/q[2], q[1]/q[2])
print("q = ", q)

error = calcGeometricError(P1, P2, H)
print("Number of correspondeces points = ", len(P1))
print("Error = ", error)
print("Error Avg. = ", error/len(P1))



